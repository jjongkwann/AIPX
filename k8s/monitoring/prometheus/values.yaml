# Helm values for kube-prometheus-stack
prometheus:
  prometheusSpec:
    retention: 15d
    retentionSize: "50GB"

    replicas: 2

    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 100Gi
          storageClassName: fast-ssd

    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi

    serviceMonitorSelector:
      matchLabels:
        monitoring: enabled

    additionalScrapeConfigs:
    - job_name: 'aipx-services'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - aipx
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2

alertmanager:
  alertmanagerSpec:
    replicas: 2
    storage:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
          storageClassName: fast-ssd

  config:
    global:
      resolve_timeout: 5m
      slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'default'
      routes:
      - match:
          severity: critical
        receiver: 'critical'
        continue: true
      - match:
          severity: warning
        receiver: 'warning'

    receivers:
    - name: 'default'
      slack_configs:
      - channel: '#aipx-alerts'
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'

    - name: 'critical'
      slack_configs:
      - channel: '#aipx-critical'
        title: 'CRITICAL: {{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'
      pagerduty_configs:
      - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'

    - name: 'warning'
      slack_configs:
      - channel: '#aipx-warnings'
        title: 'WARNING: {{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'

grafana:
  enabled: true

  adminPassword: <CHANGE_ME>

  replicas: 2

  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
    - grafana.aipx.io
    tls:
    - secretName: grafana-tls
      hosts:
      - grafana.aipx.io

  persistence:
    enabled: true
    size: 10Gi
    storageClassName: fast-ssd

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: 'aipx-dashboards'
        orgId: 1
        folder: 'AIPX'
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/aipx

  dashboardsConfigMaps:
    aipx: "grafana-dashboards"

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus-operated:9090
        access: proxy
        isDefault: true
      - name: Loki
        type: loki
        url: http://loki:3100
        access: proxy
      - name: Jaeger
        type: jaeger
        url: http://jaeger-query:16686
        access: proxy

nodeExporter:
  enabled: true

kubeStateMetrics:
  enabled: true
